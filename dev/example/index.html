<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Tutorial · MCMCTesting.jl</title><meta name="title" content="Tutorial · MCMCTesting.jl"/><meta property="og:title" content="Tutorial · MCMCTesting.jl"/><meta property="twitter:title" content="Tutorial · MCMCTesting.jl"/><meta name="description" content="Documentation for MCMCTesting.jl."/><meta property="og:description" content="Documentation for MCMCTesting.jl."/><meta property="twitter:description" content="Documentation for MCMCTesting.jl."/><meta property="og:url" content="https://Red-Portal.github.io/MCMCTesting.jl/example/"/><meta property="twitter:url" content="https://Red-Portal.github.io/MCMCTesting.jl/example/"/><link rel="canonical" href="https://Red-Portal.github.io/MCMCTesting.jl/example/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">MCMCTesting.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li class="is-active"><a class="tocitem" href>Tutorial</a><ul class="internal"><li><a class="tocitem" href="#Problem-Setup"><span>Problem Setup</span></a></li><li><a class="tocitem" href="#Testing-the-Gibbs-Sampler"><span>Testing the Gibbs Sampler</span></a></li><li><a class="tocitem" href="#Visualizing-Simulated-Ranks"><span>Visualizing Simulated Ranks</span></a></li></ul></li><li><a class="tocitem" href="../general/">General Usage</a></li><li><a class="tocitem" href="../twosampletest/">Two-Sample Tests</a></li><li><a class="tocitem" href="../exactranktest/">Exact Rank Tests</a></li><li><a class="tocitem" href="../ranksim/">Visualizing Ranks</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Tutorial</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Tutorial</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Red-Portal/MCMCTesting.jl/blob/main/docs/src/example.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="tutorial"><a class="docs-heading-anchor" href="#tutorial">Tutorial</a><a id="tutorial-1"></a><a class="docs-heading-anchor-permalink" href="#tutorial" title="Permalink"></a></h1><h2 id="Problem-Setup"><a class="docs-heading-anchor" href="#Problem-Setup">Problem Setup</a><a id="Problem-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Problem-Setup" title="Permalink"></a></h2><p>Let&#39;s consider a simple Normal-Normal model:</p><p class="math-container">\[\begin{aligned}
\theta_1 &amp;\sim \mathrm{normal}\left(0,   \sigma^2\right) \\
\theta_2 &amp;\sim \mathrm{normal}\left(0,   \sigma^2\right) \\
y        &amp;\sim \mathrm{normal}\left(\theta_1 + \theta_2, \sigma_{\epsilon}^2\right).
\end{aligned}\]</p><p>The joint log-likelihood can be implemented as follows:</p><pre><code class="language-julia hljs">using Random
using Distributions

struct Model
    sigma    ::Float64
    sigma_eps::Float64
    y        ::Float64
end
nothing</code></pre><p>For sampling from the posterior, a simple Gibbs sampling strategy is possible:</p><pre><code class="language-julia hljs">struct Gibbs end

function complete_conditional(θ::Real, σ²::Real, σ²_ϵ::Real, y::Real)
    μ = σ²/(σ²_ϵ + σ²)*(y - θ)
    σ = 1/sqrt(1/σ²_ϵ + 1/σ²)
    Normal(μ, σ)
end

function step(rng::Random.AbstractRNG, model::Model, ::Gibbs, θ)
    θ    = copy(θ)
    y    = model.y
    σ²   = model.sigma^2
    σ²_ϵ = model.sigma_eps^2
    θ[1] = rand(rng, complete_conditional(θ[2], σ², σ²_ϵ, y))
    θ[2] = rand(rng, complete_conditional(θ[1], σ², σ²_ϵ, y))
    θ
end
nothing</code></pre><h2 id="Testing-the-Gibbs-Sampler"><a class="docs-heading-anchor" href="#Testing-the-Gibbs-Sampler">Testing the Gibbs Sampler</a><a id="Testing-the-Gibbs-Sampler-1"></a><a class="docs-heading-anchor-permalink" href="#Testing-the-Gibbs-Sampler" title="Permalink"></a></h2><p>All of the functionalities of <code>MCMCTesting</code> assume that we can sample from the joint distribution <span>$p(\theta, y)$</span>. This is done by as follows:</p><pre><code class="language-julia hljs">using MCMCTesting

function MCMCTesting.sample_joint(rng::Random.AbstractRNG, model::Model)
    θ₁ = rand(rng, Normal(0, model.sigma))
    θ₂ = rand(rng, Normal(0, model.sigma))
    θ  = [θ₁, θ₂]
    y  = rand(rng, Normal(θ[1] + θ[2], model.sigma_eps))
    θ, y
end
nothing</code></pre><p>The Gibbs samplers can be connected to <code>MCMCTesting</code> by implementing the following:</p><pre><code class="language-julia hljs">using Accessors

function MCMCTesting.markovchain_transition(
    rng::Random.AbstractRNG, model::Model, kernel, θ, y
)
    model′ = @set model.y = only(y)
    step(rng, model′, kernel, θ)
end
nothing</code></pre><p>Let&#39;s check that the implementation is correct by </p><pre><code class="language-julia hljs">model = Model(1., .5, randn())
kernel = Gibbs()
test = TwoSampleTest(100, 100)
subject = TestSubject(model, kernel)
seqmcmctest(test, subject, 0.0001, 100; show_progress=false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">true</code></pre><p><code>true</code> means that the tests have passed.</p><p>Now, let&#39;s consider two erroneous implementations:</p><pre><code class="language-julia hljs">struct GibbsWrongMean end

function complete_conditional_wrongmean(θ::Real, σ²::Real, σ²_ϵ::Real, y::Real)
    μ = σ²/(σ²_ϵ + σ²)*(y + θ)
    σ = 1/sqrt(1/σ²_ϵ + 1/σ²)
    Normal(μ, σ)
end

function step(rng::Random.AbstractRNG, model::Model, ::GibbsWrongMean, θ)
    θ    = copy(θ)
    y    = model.y
    σ²   = model.sigma^2
    σ²_ϵ = model.sigma_eps^2

    θ[1] = rand(rng, complete_conditional_wrongmean(θ[2], σ², σ²_ϵ, y))
    θ[2] = rand(rng, complete_conditional_wrongmean(θ[1], σ², σ²_ϵ, y))
    θ
end

struct GibbsWrongVar end

function complete_conditional_wrongvar(θ::Real, σ²::Real, σ²_ϵ::Real, y::Real)
    μ = σ²/(σ²_ϵ + σ²)*(y - θ)
    Normal(μ, sqrt(σ²))
end

function step(rng::Random.AbstractRNG, model::Model, ::GibbsWrongVar, θ)
    θ    = copy(θ)
    y    = model.y
    σ²   = model.sigma^2
    σ²_ϵ = model.sigma_eps^2

    if rand(Bernoulli(0.5))
        θ[1] = rand(rng, complete_conditional_wrongvar(θ[2], σ², σ²_ϵ, y))
        θ[2] = rand(rng, complete_conditional_wrongvar(θ[1], σ², σ²_ϵ, y))
    else
        θ[2] = rand(rng, complete_conditional_wrongvar(θ[1], σ², σ²_ϵ, y))
        θ[1] = rand(rng, complete_conditional_wrongvar(θ[2], σ², σ²_ϵ, y))
    end
    θ
end
nothing</code></pre><p>The kernel with a wrong mean fails:</p><pre><code class="language-julia hljs">kernel = GibbsWrongMean()
subject = TestSubject(model, kernel)
seqmcmctest(test, subject, 0.0001, 100; show_progress=false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">false</code></pre><p>and so does the one with the wrong variance:</p><pre><code class="language-julia hljs">kernel = GibbsWrongVar()
subject = TestSubject(model, kernel)
seqmcmctest(test, subject, 0.0001, 100; show_progress=false)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">false</code></pre><h2 id="Visualizing-Simulated-Ranks"><a class="docs-heading-anchor" href="#Visualizing-Simulated-Ranks">Visualizing Simulated Ranks</a><a id="Visualizing-Simulated-Ranks-1"></a><a class="docs-heading-anchor-permalink" href="#Visualizing-Simulated-Ranks" title="Permalink"></a></h2><p><code>MCMCTesting</code> also provides some basic plot recipes for visualizing the simulated rank for the <a href="../exactranktest/#exactrank">exact rank test</a>. For this, <code>Plots</code> must be imported <em>before</em> <code>MCMCTesting</code>.</p><pre><code class="language-julia hljs">using Plots
gr()
using MCMCTesting
nothing</code></pre><p>Also, since the exact rank test explicitly requires the MCMC kernel to be reversible, we modify the previous Gibbs sampler to use a random scan order.</p><pre><code class="language-julia hljs">function step(rng::Random.AbstractRNG, model::Model, ::Gibbs, θ)
    θ    = copy(θ)
    y    = model.y
    σ²   = model.sigma^2
    σ²_ϵ = model.sigma_eps^2
    if rand(Bernoulli(0.5))
        θ[1] = rand(rng, complete_conditional(θ[2], σ², σ²_ϵ, y))
        θ[2] = rand(rng, complete_conditional(θ[1], σ², σ²_ϵ, y))
    else
        θ[2] = rand(rng, complete_conditional(θ[1], σ², σ²_ϵ, y))
        θ[1] = rand(rng, complete_conditional(θ[2], σ², σ²_ϵ, y))
    end
    θ
end

function step(rng::Random.AbstractRNG, model::Model, ::GibbsWrongVar, θ)
    θ    = copy(θ)
    y    = model.y
    σ²   = model.sigma^2
    σ²_ϵ = model.sigma_eps^2
    if rand(Bernoulli(0.5))
        θ[1] = rand(rng, complete_conditional_wrongvar(θ[2], σ², σ²_ϵ, y))
        θ[2] = rand(rng, complete_conditional_wrongvar(θ[1], σ², σ²_ϵ, y))
    else
        θ[2] = rand(rng, complete_conditional_wrongvar(θ[1], σ², σ²_ϵ, y))
        θ[1] = rand(rng, complete_conditional_wrongvar(θ[2], σ², σ²_ϵ, y))
    end
    θ
end
nothing</code></pre><p>Then, we can simulate the ranks and then plot them using <code>Plots</code>.</p><pre><code class="language-julia hljs">test = ExactRankTest(10000, 30, 10)

rank_correct = simulate_ranks(test, TestSubject(model, Gibbs()); show_progress=false)
rank_wrong = simulate_ranks(test, TestSubject(model, GibbsWrongVar()); show_progress=false)

stat_names = [&quot;θ1 mean correct&quot;, &quot;θ2 mean correct&quot;, &quot;θ1 var correct&quot;, &quot;θ2 var correct&quot;]
rankplot(test, rank_correct; stat_names)

stat_names = [&quot;θ1 mean wrong&quot;, &quot;θ2 mean wrong&quot;, &quot;θ1 var wrong&quot;, &quot;θ2 var wrong&quot;]
rankplot!(test, rank_wrong; stat_names)

savefig(&quot;rankplot.svg&quot;)
nothing</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">qt.qpa.xcb: could not connect to display
qt.qpa.plugin: From 6.5.0, xcb-cursor0 or libxcb-cursor0 is needed to load the Qt xcb platform plugin.
qt.qpa.plugin: Could not load the Qt platform plugin &quot;xcb&quot; in &quot;&quot; even though it was found.
This application failed to start because no Qt platform plugin could be initialized. Reinstalling the application may fix this problem.

Available platform plugins are: xcb, eglfs, minimal, vkkhrdisplay, offscreen, minimalegl, linuxfb, vnc.

Aborted (core dumped)
connect: Connection refused
GKS: can&#39;t connect to GKS socket application

GKS: Open failed in routine OPEN_WS
GKS: GKS not in proper state. GKS must be either in the state WSOP or WSAC in routine ACTIVATE_WS</code></pre><p><img src="../rankplot.svg" alt/></p><p>If the MCMC kernel under test is reversible and correct, the ranks must resemble samples from a uniform distribution. The colored bands around black line show the 1σ, 2σ, and 3σ deviations from the null hypothesis. Here, we can see that the ranks of the erroneous kernel are not uniform.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../">« Home</a><a class="docs-footer-nextpage" href="../general/">General Usage »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.2 on <span class="colophon-date" title="Tuesday 28 November 2023 21:58">Tuesday 28 November 2023</span>. Using Julia version 1.6.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
